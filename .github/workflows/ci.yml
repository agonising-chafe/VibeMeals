name: CI
on:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: package-lock.json
      
      - name: Install dependencies
        run: npm ci

      - name: Validate package.json / package-lock.json consistency
        run: |
          npm ci --prefer-offline --no-audit
          git diff --exit-code package.json package-lock.json

      - name: Lint TypeScript (ESLint)
        run: npm run lint:ts
      
      - name: Type-check TypeScript
        run: npx tsc --noEmit
      
      - name: Validate type sync
        id: validate
        run: |
          npm run validate:types
        # Allow the job to continue so we can provide a helpful message/step when validation fails
        continue-on-error: true
      
      - name: Fail on spec drift
        # This step will run only if the validation step failed (we used continue-on-error above)
        if: ${{ steps.validate.outcome == 'failure' }}
        run: |
          echo "❌ Spec drift detected: types.ts and data-model.md are out of sync. Please update both files and re-run validation." && exit 1
      
      - name: Run tests
        run: npm test
      
      - name: Lint Markdown (pragmatic)
        run: npm run lint:md

      # NOTE: Strict markdown linting and the lint artifact upload are handled
      # by the separate `docs-lint` job, which only runs strict linting when
      # doc-related files change. We keep the pragmatic lint in the build job
      # to catch common issues without the strict policy.
  
  docs-lint:
    name: Docs Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Filter changed paths
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            docs:
              - 'docs/**'
            github:
              - '.github/**'

      - name: Lint Markdown (strict) — docs-only
        if: ${{ steps.changes.outputs.docs == 'true' || steps.changes.outputs.github == 'true' }}
        run: |
          mkdir -p reports
          bash -lc 'npm run lint:md:strict > reports/markdown-lint-strict.txt 2>&1; rc=$?; if [ $rc -ne 0 ]; then echo "❌ Strict markdown lint found issues; see artifact markdown-lint-strict"; cat reports/markdown-lint-strict.txt; exit $rc; fi'

      - name: Upload markdown lint report (docs-only)
        if: ${{ steps.changes.outputs.docs == 'true' || steps.changes.outputs.github == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: markdown-lint-strict
          path: reports/markdown-lint-strict.txt
          retention-days: 7
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Scan docs for drift
        run: python scripts/scan-docs-drift.py
      
      - name: Upload drift report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: doc-drift-report
          path: reports/doc-drift-report.txt
          retention-days: 30
